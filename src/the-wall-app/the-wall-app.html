<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../bower_components/app-media/app-media-devices.html">
<link rel="import" href="../../bower_components/app-media/app-media-stream.html">
<link rel="import" href="../../bower_components/app-media/app-media-video.html">
<link rel="import" href="../../bower_components/app-media/app-media-audio.html">
<link rel="import" href="../../bower_components/app-media/app-media-waveform.html">
<link rel="import" href="../../bower_components/app-media/app-media-recorder.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="the-wall-icons.html">


<dom-module id="the-wall-app">
    <template>
        <style>
            :host {
                position: relative;
                display: block;
                overflow: hidden;
            }
            :host(.recording) #waveform {
                transform: translateY(0);
                transition-delay: 0s;
            }
            :host(.recording) #progress {
                opacity: 1;
                transition-delay: 0s;
            }
            #progress {
                position: absolute;
                pointer-events: none;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 10px;
                transform: translateX(-100%);
                transition: transform 0.3s linear, opacity 0.3s 0.3s;
                will-change: transform;
                background-color: #24CAFF;
                opacity: 0;
            }
            #waveform {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                transition: transform 0.3s;
                transition-delay: 0.3s;
                transform: translateY(100%);
                z-index: 1;
            }
            #recordings {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-start;
                justify-content: flex-start;
                box-sizing: border-box;
                padding: 14px;
            }
            #recordings app-media-video {
                width: 128px;
                height: 128px;
                margin-right: 17px;
            }
            app-media-waveform {
                height: 160px;
            }
            paper-fab {
                background-color: #444;
            }
        </style>
        <!-- The computer is connected to devices... -->
        <app-media-devices 
            kind="videoinput" 
            selected-device="{{videoDevice}}">
        </app-media-devices>

        <app-media-devices 
            kind="audioinput" 
            selected-device="{{audioDevice}}">
        </app-media-devices>

        <!-- ...devices are connected to the media stream.... -->
        <app-media-stream
            video-device="[[videoDevice]]"
            audio-device="[[audioDevice]]"
            stream="{{stream}}"
            active>
        </app-media-stream>

        <!-- ...media stream is connected to the video output... -->
        <paper-dialog>
            <paper-dialog-scrollable>
                <div style="position:relative">
                <app-media-video
                    id="video"
                    source="[[stream]]"
                    on-click="record"
                    autoplay
                    muted
                    mirror>
                </app-media-video>
                <div id="progress"></div>
                </div>
            </paper-dialog-scrollable>
        </paper-dialog>

        <!-- ...and the recorder... -->
        <app-media-recorder
            id="recorder"
            stream="[[stream]]"
            duration="[[duration]]"
            elapsed="{{elapsed}}"
            data="{{recording}}">
        </app-media-recorder>

        <!-- ...and the audio analyser... -->
        <app-media-audio
            source="[[stream]]"
            analyser="{{analyser}}">
        </app-media-audio>

        <section id="recordings">
          <template is="dom-repeat" items="[[recordings]]" as="recording">
            <a href="[[_toObjectURL(recording)]]" download="video.webm">
              <app-media-video
                  source="[[recording]]"
                  loop
                  autoplay
                  muted>
              <app-media-video>
            </a>
          </template>
        </section>

        <!-- ...analyser is connceted to the waveform visualizer! -->
        <app-media-waveform
            id="waveform"
            analyser="[[analyser]]"
            active>
        </app-media-waveform>

        <paper-fab on-tap="openDialog" icon="the-wall-icons:add-a-photo"></paper-fab>

    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class TheWallApp extends Polymer.Element {
            static get is() { return 'the-wall-app'; }
            static get properties() {
                return {
                    recording: {
                        type: Blob,
                        observer: '_recordingChanged'
                    },
                    recordings: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    duration: {
                        type: Number,
                        value: 3000
                    },
                    elapsed: {
                        type: Number,
                        observer: '_elapsedChanged'
                    }
                };
            }
            _recordingChanged(recording) {
                if (recording != null) {
                    this.push('recordings', recording);
                }
                this.classList.remove('recording');
                setTimeout(() => {
                    this.$.progress.style.transform = '';
                }, 600);
            }
            _elapsedChanged(elapsed) {
                var progress = Math.min(100 * elapsed / this.duration, 100);
                this.$.progress.style.transform = 'translateX(' + (-100 + progress) + '%)';
            }
            _toObjectURL(blob) {
                return URL.createObjectURL(blob);
            }
            openDialog() {
                this.shadowRoot.querySelector('paper-dialog').open();
            }
            record() {
                this.classList.add('recording');
                this.$.recorder.start();
            }
        }

        window.customElements.define(TheWallApp.is, TheWallApp);
    </script>
</dom-module>